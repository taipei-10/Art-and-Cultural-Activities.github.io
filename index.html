<script>
// ====== 1) 正式資料源與行政區界線 ======
const CULTURE_API = "https://cultureexpress.taipei/OpenData/Event/C000003"; // 文化快遞 OpenData
const TPE_TOWNS_TOPO = "https://raw.githubusercontent.com/jason2506/Taiwan.TopoJSON/master/topojson/towns/63000.json"; // 臺北市12行政區 TopoJSON

// ====== 2) 將文化快遞資料轉成你現有格式 ======
function normalize(evt){
  // 票價：可能為字串，嘗試擷取數字區間
  const priceTxt = (evt.TicketPrice||"").replace(/,/g,"");
  const prices = [...priceTxt.matchAll(/\d+/g)].map(x=>Number(x[0]));
  const priceMin = prices.length? Math.min(...prices): null;
  const priceMax = prices.length? Math.max(...prices): null;

  // 類型：Category，常見如「表演藝術/視覺藝術/電影/親子」等
  const type = evt.Category || "";

  // 時間：以單一場或區間為主
  const startISO = (evt.SessionStartDate || evt.StartDate || "").replace(" ", "T");
  const endISO   = (evt.SessionEndDate   || evt.EndDate   || "").replace(" ", "T");

  // 地點與座標
  const lat = Number(evt.Latitude);
  const lng = Number(evt.Longitude);

  // 行政區：evt.Area 例如「士林區」
  return {
    title: evt.Caption || "",
    desc:  evt.Introduction || "",
    type,
    start_at: startISO || new Date().toISOString(),
    end_at:   endISO   || startISO || new Date().toISOString(),
    url: evt.WebsiteLink || evt.RelatedLink || "",
    price_min: isFinite(priceMin)? priceMin : null,
    price_max: isFinite(priceMax)? priceMax : null,
    venue: {
      name: evt.Venue || evt.Address || "",
      district: evt.Area || "",
      lat, lng
    }
  };
}

// ====== 3) 取數據並依你的 UI 條件過濾 ======
async function fetchCultureEvents(){
  // 提醒：若遇到 CORS，請改走你後端 proxy（把 API_BASE 設成你後端）再轉發
  const res = await fetch(CULTURE_API);
  const raw = await res.json();             // 陣列
  const list = raw.map(normalize);

  // 依「近幾天」與關鍵篩選過濾
  const p = params();
  const now = new Date(p.start);
  const until = new Date(p.end);

  return list.filter(e=>{
    const st = new Date(e.start_at);
    const ed = new Date(e.end_at || e.start_at);
    const inRange = (st<=until) && (ed>=now);

    const typeOk = !p.types || e.type.includes(p.types);
    const distOk = !p.district || e.venue?.district===p.district;
    const priceOk = !p.price_max || (e.price_min==null && e.price_max==null) || ( (e.price_min??0) <= p.price_max );

    // 自然語言關鍵字（q）
    const q = (p.q||"").trim();
    const qOk = !q || [e.title,e.desc,e.venue?.name,e.type,e.venue?.district].some(s=> (s||"").includes(q));

    // 半徑（若有座標）
    let radiusOk = true;
    if(p.radius_km && e.venue?.lat && e.venue?.lng){
      const d = haversineKm([p.lat,p.lng],[e.venue.lat,e.venue.lng]);
      radiusOk = d <= p.radius_km;
    }
    return inRange && typeOk && distOk && priceOk && qOk && radiusOk;
  });
}

// ====== 4) 替換原本 search()：優先用文化快遞，失敗再 fallback ======
async function search(){
  const box = qs("results"); box.innerHTML = "載入中…";
  try{
    const list = await fetchCultureEvents();
    render(list);
  }catch(err){
    console.error(err);
    // 仍保留你的本地 fallback
    const r = await fetch(FALLBACK_JSON);
    const data = await r.json();
    render(data.results || data);
  }
}

// ====== 5) 載入正式行政區界線（TopoJSON → GeoJSON） ======
async function loadDistricts(){
  const topo = await fetch(TPE_TOWNS_TOPO).then(r=>r.json());
  // 只轉 district 邊界
  const geo = topojson.feature(topo, topo.objects.towns); // 需引入 topojson-client
  map.addSource('tpe-dists',{type:'geojson', data: geo});
  map.addLayer({ id:'tpe-fill', type:'fill', source:'tpe-dists', paint:{'fill-color':'#0080ff','fill-opacity':0.08}});
  map.addLayer({ id:'tpe-line', type:'line', source:'tpe-dists', paint:{'line-color':'#0060b0','line-width':1}});
  map.on('click','tpe-fill', e=>{
    const name = e.features[0].properties.TOWNNAME; // 欄位：行政區名
    new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<b>${name}</b>`).addTo(map);
    qs('dist').value = name;
    search();
  });
  map.on('mouseenter','tpe-fill', ()=> map.getCanvas().style.cursor='pointer');
  map.on('mouseleave','tpe-fill', ()=> map.getCanvas().style.cursor='');
}

// ====== 6) 工具：Haversine ======
function haversineKm(a,b){
  const toRad = d=>d*Math.PI/180;
  const R=6371, dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]);
  const lat1=toRad(a[0]), lat2=toRad(b[0]);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));
}

// ====== 7) 初始化：改為載入 TopoJSON 後再查詢 ======
async function init(){
  initMap(); geolocate();
  await loadDistricts();
  await search();
}
</script>

<!-- 在結尾前加入 topojson-client（用於 TopoJSON 轉 GeoJSON）-->
<script src="https://unpkg.com/topojson-client@3"></script>
<script>
init();
</script>
