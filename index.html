<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>台北藝文活動搜尋</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="wrap">
    <h1>台北藝文活動搜尋</h1>
    <form id="filters" class="filters" autocomplete="off">
      <label>
        類型
        <select id="type">
          <option value="">全部</option>
        </select>
      </label>
      <label>
        行政區
        <select id="district">
          <option value="">全部</option>
        </select>
      </label>
      <label>
        星期
        <select id="weekday">
          <option value="">全部</option>
          <option value="1">週一</option>
          <option value="2">週二</option>
          <option value="3">週三</option>
          <option value="4">週四</option>
          <option value="5">週五</option>
          <option value="6">週六</option>
          <option value="0">週日</option>
        </select>
      </label>
      <label class="grow">
        關鍵字
        <input id="q" type="search" placeholder="活動名稱、場館…">
      </label>
      <button type="reset" id="resetBtn">清除</button>
    </form>
  </header>

  <main class="wrap">
    <section id="source-hint" class="hint"></section>
    <section id="results" class="cards" aria-live="polite"></section>
    <template id="card-tpl">
      <article class="card">
        <a class="card__link" target="_blank" rel="noopener" aria-label="開啟活動連結"></a>
        <div class="card__body">
          <h3 class="card__title"></h3>
          <p class="card__meta"></p>
          <p class="card__desc"></p>
          <p class="card__venue"></p>
        </div>
      </article>
    </template>
  </main>

  <footer class="wrap foot">
    <small>資料來源：臺北市資料大平台與自備清單</small>
  </footer>

  <script>
    // ---------- helpers ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const fmtDate = (iso) => {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d)) return iso;
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
      const w = "日一二三四五六".charAt(d.getDay());
      const hh = String(d.getHours()).padStart(2,'0'), mm = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${da}(${w}) ${hh}:${mm}`;
    };
    const weekdayOf = (iso) => {
      if (!iso) return null;
      const d = new Date(iso);
      return Number.isNaN(d) ? null : d.getDay();
    };
    const unique = (arr) => Array.from(new Set(arr)).filter(Boolean);

    // ---------- state ----------
    let ALL = [];

    // ---------- init ----------
    async function boot() {
      const res = await fetch('data.json');
      const cfg = await res.json();

      // source note
      $('#source-hint').textContent = cfg.sources?.map(s => s.name).join('、') || '';

      // preload options
      const typeSet = new Set(cfg.types || []);
      const distSet = new Set(cfg.districts || []);
      (cfg.events || []).forEach(ev => {
        if (ev.type) typeSet.add(ev.type);
        if (ev?.venue?.district) distSet.add(ev.venue.district);
      });

      fillSelect($('#type'), [...typeSet].sort());
      fillSelect($('#district'), [...distSet].sort());

      // data
      ALL = normalizeMany(cfg.events || []);

      // render
      render();

      // bind
      $('#filters').addEventListener('input', render);
      $('#filters').addEventListener('reset', (e) => {
        // allow reset to clear, then re-render
        setTimeout(render, 0);
      });
    }

    function fillSelect(sel, items) {
      items.forEach(v => {
        const o = document.createElement('option');
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }

    function normalizeMany(list) {
      return list.map(e => ({
        id: e.id || crypto.randomUUID(),
        title: e.title || e.name || '未命名活動',
        desc: e.desc || e.description || '',
        type: e.type || '',
        start_at: e.start_at || e.start || e.begin || '',
        end_at: e.end_at || e.end || '',
        url: e.url || e.link || '#',
        venue: {
          name: e.venue?.name || e.place || '',
          address: e.venue?.address || '',
          district: e.venue?.district || '',
          lat: e.venue?.lat || null,
          lng: e.venue?.lng || null,
        },
        price_min: e.price_min ?? null,
        price_max: e.price_max ?? null
      }));
    }

    function getFilters() {
      return {
        type: $('#type').value.trim(),
        district: $('#district').value.trim(),
        weekday: $('#weekday').value.trim(),
        q: $('#q').value.trim().toLowerCase(),
      };
    }

    function match(ev, f) {
      if (f.type && ev.type !== f.type) return false;
      if (f.district && ev.venue?.district !== f.district) return false;
      if (f.weekday !== "") {
        const w1 = weekdayOf(ev.start_at);
        const w2 = weekdayOf(ev.end_at);
        const target = Number(f.weekday);
        if (w1 === null && w2 === null) return false;
        const ok = (w1 === target) || (w2 === target);
        if (!ok) return false;
      }
      if (f.q) {
        const hay = [
          ev.title, ev.desc, ev.type, ev.venue?.name, ev.venue?.address, ev.venue?.district
        ].join(' ').toLowerCase();
        if (!hay.includes(f.q)) return false;
      }
      return true;
    }

    function render() {
      const f = getFilters();
      const list = ALL.filter(ev => match(ev, f));
      const wrap = $('#results');
      wrap.innerHTML = '';
      if (!list.length) {
        wrap.innerHTML = '<p class="hint">查無活動，請嘗試其他條件。</p>';
        return;
      }
      const tpl = $('#card-tpl');
      list.forEach(ev => {
        const node = tpl.content.cloneNode(true);
        const link = $('.card__link', node);
        const title = $('.card__title', node);
        const meta = $('.card__meta', node);
        const desc = $('.card__desc', node);
        const venue = $('.card__venue', node);

        link.href = ev.url || '#';
        title.textContent = ev.title;
        const time = [fmtDate(ev.start_at), fmtDate(ev.end_at)].filter(Boolean).join(' — ');
        const typeTxt = ev.type ? `｜${ev.type}` : '';
        meta.textContent = [time, typeTxt].filter(Boolean).join(' ');
        desc.textContent = ev.desc || '';
        const loc = [ev.venue?.name, ev.venue?.district, ev.venue?.address].filter(Boolean).join('，');
        venue.textContent = loc;

        wrap.appendChild(node);
      });
    }

    boot();
  </script>
</body>
</html>
