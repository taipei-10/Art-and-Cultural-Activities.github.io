<!doctype html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å°åŒ—è—æ–‡ãƒ»æ™ºæ…§æœå°‹</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://unpkg.com/@turf/turf@6"></script>

<link rel="stylesheet" href="./styles.css" />
<script>tailwind.config={theme:{extend:{colors:{brand:'#0ea5e9'}}},darkMode:'class'}</script>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
<div class="max-w-6xl mx-auto p-4">
  <header class="mb-4 flex items-start justify-between gap-3">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold">å°åŒ—å¸‚æœ€è¿‘å¹¾å¤©è—æ–‡æ´»å‹•</h1>
      <p class="text-sm text-gray-600 dark:text-gray-400">ç¨®é¡ãƒ»å¤©æ•¸ãƒ»è·é›¢ãƒ»è¡Œæ”¿å€ãƒ»é—œéµå­—ï¼Œå³æ™‚ç¯©é¸ï¼›ä¸¦åŒæ­¥æœè‡ºåŒ—å¸‚è³‡æ–™å¤§å¹³å°</p>
    </div>
    <button id="darkToggle" class="px-3 py-2 text-sm border rounded-md">æ·±æ·ºåˆ‡æ›</button>
  </header>

  <!-- ç¯©é¸åˆ— -->
  <section class="sticky top-0 z-30 bg-white/80 dark:bg-gray-900/80 backdrop-blur border rounded-md p-3 mb-4">
    <div class="grid md:grid-cols-3 gap-3">
      <div class="md:col-span-2 flex gap-2">
        <input id="q" class="flex-1 border rounded-md px-3 py-2 dark:bg-gray-900 dark:border-gray-700"
               placeholder="è¼¸å…¥é—œéµå­—ï¼šä¾‹ æ˜å¾Œå¤© å£«æ— å±•è¦½ 300å…ƒä»¥ä¸‹" />
        <button id="btn" class="px-4 py-2 bg-black text-white rounded-md dark:bg-gray-200 dark:text-gray-900">æœå°‹</button>
      </div>
      <div class="grid grid-cols-4 gap-2">
        <select id="type" class="border rounded-md px-2 py-2 dark:bg-gray-900 dark:border-gray-700">
          <option value="">å…¨éƒ¨é¡å‹</option><option>å±•è¦½</option><option>è¡¨æ¼”</option>
          <option>è¬›åº§</option><option>é›»å½±</option><option>å¸‚é›†</option>
        </select>
        <select id="days" class="border rounded-md px-2 py-2 dark:bg-gray-900 dark:border-gray-700">
          <option value="3" selected>è¿‘3å¤©</option><option value="7">è¿‘7å¤©</option>
        </select>
        <select id="radius" class="border rounded-md px-2 py-2 dark:bg-gray-900 dark:border-gray-700">
          <option value="2">2km</option><option value="5" selected>5km</option><option value="10">10km</option><option value="20">20km</option>
        </select>
        <select id="dist" class="border rounded-md px-2 py-2 dark:bg-gray-900 dark:border-gray-700">
          <option value="">å…¨å°åŒ—å¸‚</option>
        </select>
      </div>
    </div>
  </section>

  <!-- åœ°åœ– -->
  <section class="rounded-md border mb-4 relative overflow-hidden">
    <div id="map"></div>
    <div class="map-tools">
      <button id="btnGeo" class="tool-btn" title="å®šä½åˆ°æˆ‘">ğŸ“</button>
      <button id="btnClearRoute" class="tool-btn" title="æ¸…é™¤è·¯ç·š">âœ–ï¸</button>
    </div>
    <div id="coord" class="absolute right-2 top-2 bg-white/90 dark:bg-gray-800/80 border dark:border-gray-700 rounded px-2 py-1 text-xs font-mono"></div>
  </section>

  <!-- å…§å®¹ -->
  <section class="grid md:grid-cols-3 gap-4 items-start">
    <aside class="md:col-span-1 space-y-3">
      <div class="rounded-md border p-3">
        <label class="block text-sm mb-2">ç¥¨åƒ¹ä¸Šé™ï¼ˆNT$ï¼‰</label>
        <input id="pmax" type="number" inputmode="numeric" class="border rounded-md w-full px-3 py-2 dark:bg-gray-900 dark:border-gray-700" placeholder="å¦‚ 300" />
      </div>
      <div class="flex gap-2">
        <button id="reset" class="flex-1 px-3 py-2 border rounded-md">æ¸…é™¤æ¢ä»¶</button>
        <button id="recenter" class="px-3 py-2 border rounded-md">å›åˆ°å°åŒ—</button>
      </div>
      <div id="routeInfo" class="text-xs text-gray-600 dark:text-gray-400"></div>
      <div id="alert" class="hidden text-xs mt-2 p-2 rounded bg-red-50 text-red-700 border border-red-200 dark:bg-red-900/20 dark:text-red-300 dark:border-red-800"></div>
    </aside>

    <main id="results" class="md:col-span-2 space-y-3">
      <div id="skeletonWrap" class="space-y-3">
        <div class="border rounded-md p-3 bg-white dark:bg-gray-900">
          <div class="h-5 w-48 skeleton rounded mb-2"></div>
          <div class="h-4 w-full skeleton rounded mb-1"></div>
          <div class="h-4 w-5/6 skeleton rounded mb-3"></div>
          <div class="h-8 w-40 skeleton rounded"></div>
        </div>
      </div>
    </main>
  </section>

  <!-- å¤§å¹³å°çµæœ -->
  <section id="portalResults" class="mt-6 space-y-3"></section>
</div>

<script>
/* ===== å¸¸æ•¸ ===== */
const CULTURE_API = "https://cultureexpress.taipei/OpenData/Event/C000003";
const TPE_TOWNS_TOPO = "https://raw.githubusercontent.com/jason2506/Taiwan.TopoJSON/master/topojson/towns/63000.json";
const FALLBACK_JSON = "events.json";
const CKAN = "https://data.taipei/api/3/action";

/* ===== ç‹€æ…‹ ===== */
let map, userLoc = { lat: 25.0375, lng: 121.5637 };
let markers = [];
let ringSourceId = 'search-ring';

/* ===== å·¥å…· ===== */
function qs(id){ return document.getElementById(id); }
function fmtTime(iso){ const d=new Date(iso); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${mm}/${dd} ${hh}:${mi}`; }
function haversineKm(a,b){ const toRad=d=>d*Math.PI/180; const R=6371, dLat=toRad(b[0]-a[0]), dLng=toRad(b[1]-a[1]); const lat1=toRad(a[0]), lat2=toRad(b[0]); const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
function debounce(fn, ms=400){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* ===== åœ°åœ– ===== */
function initMap(){
  map = new maplibregl.Map({ container:'map', style:'https://demotiles.maplibre.org/style.json', center:[userLoc.lng,userLoc.lat], zoom:12 });
  map.addControl(new maplibregl.NavigationControl(), 'top-left');
  new maplibregl.Marker({color:"#0ea5e9"}).setLngLat([userLoc.lng,userLoc.lat]).addTo(map);
  map.on('mousemove', e=>{ qs('coord').textContent = `${e.lngLat.lat.toFixed(6)}, ${e.lngLat.lng.toFixed(6)}`; });
  map.on('load', async ()=>{ await loadDistricts(); drawSearchRing(); });
}
async function loadDistricts(){
  const topo = await fetch(TPE_TOWNS_TOPO).then(r=>r.json());
  const geo = topojson.feature(topo, topo.objects.towns);
  map.addSource('tpe-dists',{type:'geojson', data: geo});
  map.addLayer({ id:'tpe-fill', type:'fill', source:'tpe-dists', paint:{'fill-color':'#0ea5e9','fill-opacity':0.08}});
  map.addLayer({ id:'tpe-line', type:'line', source:'tpe-dists', paint:{'line-color':'#0284c7','line-width':1}});
  // è¡Œæ”¿å€é¸å–®
  const set = new Set(geo.features.map(f=>f.properties.TOWNNAME));
  const distSel = qs('dist');
  [...set].sort().forEach(n=>{ const opt=document.createElement('option'); opt.value=n; opt.textContent=n; distSel.appendChild(opt); });
  map.on('click','tpe-fill', e=>{
    const name = e.features[0].properties.TOWNNAME;
    new maplibregl.Popup().setLngLat(e.lngLat).setHTML(`<b>${name}</b>`).addTo(map);
    distSel.value = name; search();
  });
}
async function geolocate(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(p=>{
    userLoc = {lat:p.coords.latitude, lng:p.coords.longitude};
    if(map){ map.setCenter([userLoc.lng,userLoc.lat]); drawSearchRing(); }
  }, ()=>{});
}
function drawSearchRing(){
  if(!window.turf || !map) return;
  const km = Number(qs('radius').value);
  const center = [userLoc.lng, userLoc.lat];
  const poly = turf.circle(center, km, {steps:64, units:'kilometers'});
  const fc = {type:'FeatureCollection', features:[poly]};
  if(!map.getSource(ringSourceId)){
    map.addSource(ringSourceId,{type:'geojson',data:fc});
    map.addLayer({id:'ring-fill',type:'fill',source:ringSourceId,paint:{'fill-color':'#0ea5e9','fill-opacity':0.08}});
    map.addLayer({id:'ring-line',type:'line',source:ringSourceId,paint:{'line-color':'#0284c7','line-width':2}});
  }else{
    map.getSource(ringSourceId).setData(fc);
  }
}
function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
function clearRoute(){ if(map?.getLayer('route-line')) map.removeLayer('route-line'); if(map?.getSource('route')) map.removeSource('route'); qs('routeInfo').textContent=""; }
function fitBoundsToResults(list){
  const pts = list.filter(e=>e.venue?.lng && e.venue?.lat).map(e=>[e.venue.lng,e.venue.lat]);
  if(!pts.length) return;
  const b = pts.reduce((bb,c)=>bb.extend(c), new maplibregl.LngLatBounds(pts[0],pts[0]));
  map.fitBounds(b, {padding:48, maxZoom:15});
}

/* ===== ç¯©é¸ ===== */
function params(){
  const now = new Date();
  const end = new Date(now.getTime() + Number(qs("days").value)*86400000);
  return {
    q: qs("q").value.trim(),
    lat: userLoc.lat, lng: userLoc.lng,
    radius_km: Number(qs("radius").value),
    start: now.toISOString(), end: end.toISOString(),
    types: qs("type").value,
    price_max: Number(qs("pmax").value||0) || "",
    district: qs("dist").value || ""
  };
}

/* ===== Taipei Culture API æ­£è¦åŒ–èˆ‡æ¸²æŸ“ ===== */
function normalize(evt){
  const priceTxt = (evt.TicketPrice||"").replace(/,/g,"");
  const prices = [...priceTxt.matchAll(/\d+/g)].map(x=>Number(x[0]));
  const priceMin = prices.length? Math.min(...prices): null;
  const priceMax = prices.length? Math.max(...prices): null;
  const startISO = (evt.SessionStartDate || evt.StartDate || "").replace(" ", "T");
  const endISO   = (evt.SessionEndDate   || evt.EndDate   || "").replace(" ", "T");
  const lat = Number(evt.Latitude), lng = Number(evt.Longitude);
  return {
    title: evt.Caption || "", desc: evt.Introduction || "", type: evt.Category || "",
    start_at: startISO || new Date().toISOString(),
    end_at: endISO || startISO || new Date().toISOString(),
    url: evt.WebsiteLink || evt.RelatedLink || "",
    price_min: Number.isFinite(priceMin)? priceMin : null,
    price_max: Number.isFinite(priceMax)? priceMax : null,
    venue: { name: evt.Venue || evt.Address || "", district: evt.Area || "", lat, lng }
  };
}
async function fetchCultureEvents(){
  const res = await fetch(CULTURE_API);
  if(!res.ok) throw new Error('API å¤±æ•—');
  const raw = await res.json();
  const list = raw.map(normalize);

  const p = params();
  const now = new Date(p.start);
  const until = new Date(p.end);

  list.forEach(e=>{
    if(p.lat && p.lng && e.venue?.lat && e.venue?.lng){
      e._km = haversineKm([p.lat,p.lng],[e.venue.lat,e.venue.lng]);
    }
  });

  return list.filter(e=>{
    const st = new Date(e.start_at);
    const ed = new Date(e.end_at || e.start_at);
    const inRange = (st<=until) && (ed>=now);
    const typeOk = !p.types || e.type.includes(p.types);
    const distOk = !p.district || e.venue?.district===p.district;
    const priceOk = !p.price_max || (e.price_min==null && e.price_max==null) || ((e.price_min??0) <= p.price_max);
    const q = p.q;
    const qOk = !q || [e.title,e.desc,e.venue?.name,e.type,e.venue?.district].some(s=> (s||"").includes(q));
    let radiusOk = true;
    if(p.radius_km && e.venue?.lat && e.venue?.lng){ radiusOk = e._km <= p.radius_km; }
    return inRange && typeOk && distOk && priceOk && qOk && radiusOk;
  }).sort((a,b)=>(a._km??999)-(b._km??999));
}
function render(list){
  const box = qs("results");
  qs('skeletonWrap').style.display='none';
  box.innerHTML=""; clearRoute(); clearMarkers();

  if(!list.length){
    box.innerHTML = `<div class="p-6 text-sm text-gray-600 dark:text-gray-400 border rounded-md bg-white dark:bg-gray-900">ç„¡ç¬¦åˆçµæœã€‚è«‹èª¿æ•´æ¢ä»¶æˆ–æ›é—œéµå­—ã€‚</div>`;
    return;
  }

  // markers
  list.forEach(e=>{
    if(map && e.venue?.lng && e.venue?.lat){
      const m = new maplibregl.Marker({color:"#333"}).setLngLat([e.venue.lng,e.venue.lat]).addTo(map);
      m.setPopup(new maplibregl.Popup({offset:24}).setHTML(`<b>${e.title}</b><div>${e.venue.name||""}</div>`));
      markers.push(m);
    }
  });
  fitBoundsToResults(list);

  // cards
  list.forEach(e=>{
    const card = document.createElement("article");
    card.className = "border rounded-md p-3 bg-white dark:bg-gray-900";
    const priceStr = (e.price_min==null && e.price_max==null) ? "â€”" : `${e.price_min ?? 0} â€” ${e.price_max ?? e.price_min ?? 0}`;
    const distBadge = (e._km!=null) ? `<span class="badge">è·é›¢ ${e._km.toFixed(1)}km</span>` : "";
    card.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <h3 class="font-medium text-lg">${e.title}</h3>
        <div class="flex gap-2"><span class="badge">${e.type||"â€”"}</span>${distBadge}</div>
      </div>
      <p class="text-sm text-gray-700 dark:text-gray-300 mt-1 clamp-2">${e.desc||""}</p>
      <div class="mt-2 grid sm:grid-cols-2 gap-1 text-sm">
        <p>æ™‚é–“ï¼š${fmtTime(e.start_at)} â€” ${fmtTime(e.end_at)}</p>
        <p>åœ°é»ï¼š${e.venue?.name||""}ï¼ˆ${e.venue?.district||""}ï¼‰</p>
        <p>ç¥¨åƒ¹ï¼š${priceStr}</p>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <a class="px-3 py-1.5 border rounded-md text-sm" href="${e.url||"#"}" target="_blank" rel="noopener">æ´»å‹•é€£çµ</a>
      </div>`;
    box.appendChild(card);
  });
}

/* ===== è‡ºåŒ—å¸‚è³‡æ–™å¤§å¹³å°ï¼ˆCKANï¼‰æœå°‹èˆ‡æ¸²æŸ“ ===== */
async function searchDatasets(keyword="", rows=10, start=0){
  const p = new URLSearchParams({
    rows:String(rows), start:String(start),
    sort:"metadata_modified desc", q: keyword || ""
  });
  p.append("fq",'organization:"è‡ºåŒ—å¸‚æ”¿åºœæ–‡åŒ–å±€" AND groups:æ–‡åŒ–');
  const r = await fetch(`${CKAN}/package_search?${p}`);
  const j = await r.json();
  if(!j.success) throw new Error("package_search failed");
  return j.result.results;
}
async function previewDatastore(resourceId, keyword="", limit=3){
  const p = new URLSearchParams({resource_id:resourceId, q:keyword, limit:String(limit)});
  const r = await fetch(`${CKAN}/datastore_search?${p}`);
  const j = await r.json();
  if(!j.success) throw new Error("datastore_search failed");
  return j.result.records;
}
async function renderPortal(keyword){
  const box = document.getElementById("portalResults");
  box.innerHTML = `<div class="text-sm text-gray-500 mb-1">ä¾†è‡ªè‡ºåŒ—å¸‚è³‡æ–™å¤§å¹³å°</div>`;
  try{
    const datasets = await searchDatasets(keyword, 10, 0);
    if(!datasets.length){
      box.insertAdjacentHTML("beforeend", `<div class="p-3 text-sm border rounded bg-white dark:bg-gray-900">ç„¡ç¬¦åˆè³‡æ–™é›†</div>`);
      return;
    }
    for(const ds of datasets){
      const dsLink = `https://data.taipei/dataset/${ds.name}`;
      const dsDate = (ds.metadata_modified||"").slice(0,10);
      const dsDesc = ds.notes||"";
      const dsRes = (ds.resources||[]);
      const dsActive = dsRes.find(r=>r.datastore_active===true);

      let extra = "";
      if(dsActive){
        try{
          const peek = await previewDatastore(dsActive.id, keyword||"", 3);
          extra = `<pre class="text-xs bg-gray-50 dark:bg-gray-800 p-2 rounded overflow-x-auto">${JSON.stringify(peek, null, 2)}</pre>`;
        }catch{}
      }else{
        const links = dsRes
          .filter(r=>/json|csv|xml/i.test(r.format||""))
          .map(r=>`<a class="px-2 py-1 border rounded text-xs" href="${r.url}" target="_blank" rel="noopener">${(r.format||'LINK').toUpperCase()}</a>`)
          .join(" ");
        extra = links || '<span class="text-xs text-gray-500">ç„¡å¯ç›´æ¥ä¸‹è¼‰çš„è³‡æº</span>';
      }

      const card = document.createElement("article");
      card.className = "border rounded-md p-3 bg-white dark:bg-gray-900";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-2">
          <h3 class="font-medium">${ds.title||"(ç„¡æ¨™é¡Œ)"}</h3>
          <span class="text-xs text-gray-500">${dsDate}</span>
        </div>
        <p class="text-sm text-gray-700 dark:text-gray-300 mt-1 clamp-2">${dsDesc}</p>
        <div class="mt-2 flex flex-wrap gap-2">
          <a class="px-2 py-1 border rounded text-xs" href="${dsLink}" target="_blank" rel="noopener">è³‡æ–™é›†é é¢</a>
          ${extra}
        </div>`;
      box.appendChild(card);
    }
  }catch(e){
    console.error(e);
    box.insertAdjacentHTML("beforeend", `<div class="p-3 text-sm border rounded bg-red-50 dark:bg-red-900/20">å¤§å¹³å°æŸ¥è©¢å¤±æ•—</div>`);
  }
}

/* ===== æœå°‹æµç¨‹ ===== */
async function search(){
  qs('skeletonWrap').style.display='';
  qs('results').innerHTML="";
  qs('portalResults').innerHTML="";
  qs('alert').classList.add('hidden'); qs('alert').textContent="";

  try{
    const list = await fetchCultureEvents();
    render(list);
  }catch(err){
    console.error(err);
    qs('alert').textContent = "è³‡æ–™ä¾†æºæš«æ™‚ç„¡æ³•å–å¾—ï¼Œå·²è¼‰å…¥å‚™æ´è³‡æ–™ã€‚";
    qs('alert').classList.remove('hidden');
    try{
      const r = await fetch(FALLBACK_JSON);
      const data = await r.json();
      const list = (data.results || data);
      // ç„¡ API æ™‚ä»ç…§ä½ ç«™å…§æ ¼å¼æ¸²æŸ“
      render(list);
    }catch(e2){
      qs('skeletonWrap').style.display='none';
      qs('results').innerHTML = `<div class="p-6 text-sm text-red-700 dark:text-red-300 border rounded-md bg-red-50 dark:bg-red-900/20">å‚™æ´è³‡æ–™ä¹Ÿç„¡æ³•è¼‰å…¥ã€‚</div>`;
    }
  }

  await renderPortal(qs("q").value.trim());
}

/* ===== ç¶å®š ===== */
function initUI(){
  qs("btn").onclick = search;
  qs("q").oninput = debounce(search, 500);
  ["type","days","radius","pmax","dist"].forEach(id=>qs(id).onchange = ()=>{ search(); drawSearchRing(); });
  qs("reset").onclick = ()=>{ ["q","type","pmax"].forEach(id=>qs(id).value=""); qs("days").value="3"; qs("radius").value="5"; qs("dist").value=""; search(); drawSearchRing(); };
  qs("recenter").onclick = ()=>{ userLoc={lat:25.0375,lng:121.5637}; map.flyTo({center:[userLoc.lng,userLoc.lat], zoom:12}); drawSearchRing(); };
  qs("btnGeo").onclick = geolocate;
  qs("btnClearRoute").onclick = clearRoute;

  const root=document.documentElement; const saved=localStorage.getItem('theme'); if(saved){ root.classList.toggle('dark', saved==='dark'); }
  qs('darkToggle').onclick=()=>{ const d=root.classList.toggle('dark'); localStorage.setItem('theme', d?'dark':'light'); };
}

/* ===== å•Ÿå‹• ===== */
initMap();
geolocate();
initUI();
search();
</script>
</body>
</html>
