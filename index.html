<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>臺北藝文活動搜尋</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{
  --brand:#3a86ff; --brand-ink:#0b57d0; --accent:#eef4ff;
  --bg:#f7f8fb; --panel:#ffffff; --ink:#0f1420; --ink-2:#5b6475;
  --border:#e6e8ee; --muted:#eef1f6; --shadow:0 2px 6px rgba(15,20,32,.06),0 16px 36px rgba(15,20,32,.12);
  --radius:16px; --r-sm:12px; --gap:22px;
  --fz-12:clamp(11px,.75vw,12px); --fz-14:clamp(13px,.9vw,14px); --fz-16:clamp(14px,1vw,16px);
  --fz-18:clamp(16px,1.1vw,18px); --fz-22:clamp(18px,1.6vw,22px); --fz-28:clamp(22px,2.2vw,28px); --fz-40:clamp(28px,4vw,40px);
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0f1216; --panel:#141922; --ink:#eef2f7; --ink-2:#a3adc2; --border:#1f2630; --muted:#1b2330; --accent:#17243f;
    --shadow:0 2px 8px rgba(0,0,0,.35),0 20px 44px rgba(0,0,0,.5);
  }
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:Inter,"Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",Arial,sans-serif;
  background:
    radial-gradient(600px 600px at 10% -10%, #93c5fd33, transparent 60%),
    radial-gradient(600px 600px at 100% 0%, #60a5fa22, transparent 60%),
    linear-gradient(180deg,var(--bg),#fff0 40%);
  font-size:var(--fz-16); line-height:1.65;
}
a{color:inherit}
.shell{display:grid; grid-template-columns: min(360px, 92vw) 1fr; gap:0; min-height:100dvh}
@media (max-width: 760px){ .shell{grid-template-columns: 1fr} }
.sidebar{
  position: sticky; top:0; align-self:start; height:100dvh; overflow:auto;
  background:var(--panel); border-right:1px solid var(--border); padding:24px; display:grid; grid-template-rows:auto auto 1fr auto; gap:18px;
}
@media (max-width:760px){ .sidebar{position: static; height:auto; border-right:0; border-bottom:1px solid var(--border)} }
.brand{display:flex; align-items:center; gap:12px}
.logo{inline-size:48px; block-size:48px; border-radius:14px; display:grid; place-items:center; font-weight:900; letter-spacing:1px; background:linear-gradient(135deg,var(--brand),var(--brand-ink)); color:#fff; box-shadow:var(--shadow)}
.brand .t1{font-size:var(--fz-22); font-weight:850; letter-spacing:.5px}
.panel{background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel),var(--accent) 10%)); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
.h2{font-size:var(--fz-18); margin:0 0 10px; font-weight:800}
.field{display:grid; gap:6px; margin:12px 0}
.field>span{font-size:var(--fz-12); color:var(--ink-2); letter-spacing:.4px; text-transform:uppercase}
input,select{width:100%; padding:10px 12px; font-size:var(--fz-14); border:1px solid var(--border); border-radius:10px; background:var(--panel); color:var(--ink)}
input::placeholder{color:#9aa3af}
.switch{display:flex; align-items:center; gap:10px; margin-top:8px; color:var(--ink-2)}
.actions{display:flex; gap:10px; margin-top:10px}
.btn{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--panel); cursor:pointer; font-weight:700; font-size:var(--fz-14)}
.btn.primary{background:var(--brand); border-color:var(--brand); color:#fff}
.btn.link{display:inline-flex; align-items:center; gap:6px; border-color:transparent; background:var(--accent); color:var(--brand-ink)}
.help{font-size:var(--fz-12); color:var(--ink-2); margin:8px 0 0}
.foot{font-size:var(--fz-12); color:var(--ink-2)}
.main{padding:28px min(5vw,40px)}
.hero{position:relative; overflow:hidden; border-radius:var(--radius); padding:36px; background:
  radial-gradient(1000px 400px at 70% -20%, #60a5fa33, transparent 60%),
  linear-gradient(160deg, color-mix(in oklab, var(--brand), #fff 65%), var(--panel));
  border:1px solid var(--border); box-shadow:var(--shadow); margin-bottom:24px}
.hero h1{margin:0 0 6px; font-size:var(--fz-40); font-weight:900; letter-spacing:.4px}
.hero p{margin:0; font-size:var(--fz-18); color:var(--ink-2)}
.map{width:100%; height:380px; margin:22px 0; border-radius:var(--radius); overflow:hidden; border:1px solid var(--border); box-shadow:var(--shadow)}
.grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:var(--gap)}
.card{grid-column: span 4; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); transition:.15s transform}
@media (max-width:1200px){ .card{grid-column: span 6} }
@media (max-width:760px){ .card{grid-column: span 12} }
.card:hover{transform: translateY(-2px)}
.cover{aspect-ratio: 16 / 9; width:100%; object-fit:cover; display:block}
.card-body{padding:16px 16px 18px}
.badges{display:flex; gap:8px; margin-bottom:8px}
.badge{background:color-mix(in oklab,var(--brand),#fff 80%); color:var(--brand-ink); border:1px solid color-mix(in oklab,var(--brand),#000 15%); padding:4px 10px; border-radius:999px; font-size:var(--fz-12); font-weight:800; letter-spacing:.2px}
.chip{background:var(--muted); color:color-mix(in oklab,var(--ink),#000 10%); padding:4px 10px; border-radius:999px; font-size:var(--fz-12)}
.title{margin:4px 0 6px; font-size:var(--fz-22); font-weight:900; line-height:1.35; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow:hidden}
.meta{margin:0 0 8px; font-size:var(--fz-14); color:var(--ink-2); display:flex; gap:10px; flex-wrap:wrap}
.sub{margin:0 0 6px; color:color-mix(in oklab,var(--ink),#000 12%)}
.actions{display:flex; gap:10px; margin-top:10px}
.card .btn{font-weight:700}
dialog#detail{border:0; padding:0; max-width:900px; width:min(96vw,900px); border-radius:18px; box-shadow:var(--shadow)}
dialog::backdrop{background:rgba(0,0,0,.45)}
.detail{background:var(--panel); color:var(--ink); border:1px solid var(--border); border-radius:18px; overflow:hidden}
.detail-head{display:grid; grid-template-columns: 320px 1fr}
@media (max-width:900px){ .detail-head{grid-template-columns:1fr} }
.detail-media{background:var(--muted); min-height:220px}
.detail-media img{width:100%; height:100%; object-fit:cover; display:block}
.detail-meta{padding:18px 18px 8px}
.d-title{margin:0 0 6px; font-size:var(--fz-28); font-weight:900; line-height:1.3}
.d-chips{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:6px}
.x{margin-left:auto}
.dline{margin:0 0 2px; font-size:var(--fz-14); color:var(--ink-2)}
.detail-body{padding:6px 18px 18px}
.prose{max-width:75ch}
.prose p{margin:10px 0}
.prose strong{font-weight:800}
.prose a{color:var(--brand-ink); text-decoration:underline}
.price{font-weight:800; margin-top:8px}
.toolbar{display:flex; gap:8px; margin-top:10px}
.toolbar .btn{padding:8px 10px; font-size:var(--fz-12)}
.leaflet-control-container .leaflet-control{border-radius:10px; overflow:hidden}
</style>
</head>
<body>
<div class="shell">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">
        <img alt="藝文活動圖示" style="width:48px;height:48px;border-radius:14px;display:block"
             src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 48 48'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%23ff9bd3'/><stop offset='100%' stop-color='%237c8cff'/></linearGradient></defs><rect width='48' height='48' rx='14' fill='url(%23g)'/><circle cx='24' cy='26' r='14' fill='%23ffffff'/><circle cx='19' cy='24' r='2' fill='%231f2937'/><circle cx='29' cy='24' r='2' fill='%231f2937'/><path d='M18 28c2 3 10 3 12 0' stroke='%231f2937' stroke-width='2' fill='none' stroke-linecap='round'/><circle cx='16' cy='26' r='1.5' fill='%23fca5a5' opacity='.9'/><circle cx='32' cy='26' r='1.5' fill='%23fca5a5' opacity='.9'/><path d='M35 12l2 1-1 2 2 1-2 1-1 2-1-2-2-1 2-1z' fill='%23fde047'/><path d='M12 14l3 0' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' opacity='.6'/></svg>">
      </div><div class="t1">藝文活動搜尋</div>
    </div>
    <div class="panel">
      <div class="h2">搜尋與篩選</div>
      <label class="field"><span>關鍵字</span><input id="q" type="search" placeholder="輸入活動、主辦、標籤、場館…"></label>
      <label class="field"><span>類型</span>
        <select id="type"><option value="">全部</option><option>展覽</option><option>表演</option><option>講座</option><option>電影</option><option>市集</option><option>其他</option></select>
      </label>
      <label class="field"><span>行政區</span>
        <select id="district">
          <option value="">全部</option>
          <option>中正區</option><option>大同區</option><option>中山區</option><option>松山區</option>
          <option>大安區</option><option>萬華區</option><option>信義區</option><option>士林區</option>
          <option>北投區</option><option>內湖區</option><option>南港區</option><option>文山區</option>
        </select>
      </label>
      <!-- 日期多選取代星期 -->
      <label class="field"><span>日期（可多選）</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="pickDate" type="date" />
          <button id="addDate" class="btn" type="button">加入</button>
          <button id="clearDates" class="btn" type="button">清空</button>
        </div>
        <div id="dateChips" class="switch" style="flex-wrap:wrap"></div>
      </label>
      <label class="field"><span>最大距離（公里）</span><input id="maxKm" type="number" min="0" step="0.5" placeholder="不限制"></label>
      <label class="switch"><input type="checkbox" id="useGeo"> 顯示與我距離</label>
      <div class="actions"><button id="btnFilter" class="btn">套用篩選</button></div>
      <p class="help">來源 <code>events.json</code>。自動清洗欄位、票價、主辦、標籤、講者、系列、連結等。</p>
    </div>
    <div class="foot">© Taipei Open Culture • Leaflet + OSM</div>
  </aside>

  <main class="main">
    <section class="hero">
      <h1>發現本週的藝文靈感</h1><p>搜尋更多欄位，地圖導覽，詳情一鍵到位。</p>
    </section>
    <div id="map" class="map"></div>
    <section id="list" class="grid" aria-live="polite"></section>
  </main>
</div>

<dialog id="detail" aria-labelledby="d-title">
  <article class="detail">
    <div class="detail-head">
      <div class="detail-media"><img id="d-img" alt=""></div>
      <div class="detail-meta">
        <div style="display:flex; align-items:center; gap:8px">
          <h3 id="d-title" class="d-title"></h3>
          <button id="d-close" class="btn x" aria-label="關閉">關閉</button>
        </div>
        <div class="d-chips">
          <span class="badge" id="d-type"></span><span class="chip" id="d-district"></span>
        </div>
        <p class="dline" id="d-time"></p>
        <p class="dline" id="d-venue"></p>
        <p class="dline" id="d-addr"></p>
        <div class="toolbar">
          <a id="d-url" class="btn link" target="_blank" rel="noopener">活動頁</a>
          <button id="btnShare" class="btn">分享</button><button id="btnCopy" class="btn">複製連結</button>
        </div>
      </div>
    </div>
    <div class="detail-body"><div class="prose">
      <p id="d-desc"></p><p class="price" id="d-price"></p>
    </div></div>
  </article>
</dialog>

<!-- 後備資料（找不到 events.json 時使用） -->
<script type="application/json" id="seed">
{"results":[
 {"title":"城市光影—短片巡演","desc":"精選本地創作者短片放映暨映後談。","type":"電影","start_at":"2025-10-18T19:00:00","end_at":"2025-10-18T21:00:00","url":"https://example.com/event/film","price_min":0,"price_max":200,"venue":{"name":"台北市中山堂 光點廳","district":"中正區","lat":25.0435,"lng":121.5167}},
 {"title":"王大閎建築劇場「登月：氣味與聲音劇場」","desc":"跨感官的建築與聲音裝置展演。","type":"展覽","start_at":"2025-10-21T00:00:00","end_at":"2025-12-21T23:59:59","url":"https://www.tfam.museum/","venue":{"name":"臺北市立美術館","district":"中山區","lat":25.0723,"lng":121.5249}},
 {"title":"2025自綠生活節","desc":"戶外主題市集與永續生活展。","type":"市集","start_at":"2025-10-18T00:00:00","end_at":"2025-10-19T23:59:59","url":"https://www.huashan1914.com/","venue":{"name":"華山1914文化創意產業園區","district":"中正區","lat":25.0447,"lng":121.5299}}
]}
</script>

<script>
/* ===== 地圖與狀態 ===== */
const TAIPEI_CENTER=[25.0419,121.5654];
const TAIPEI_DISTRICTS=new Set(["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"]);
const map=L.map('map',{scrollWheelZoom:false}).setView(TAIPEI_CENTER,12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
let meMarker=null,myPos=null,markers=L.layerGroup().addTo(map);
let allEvents=[];

/* 新增：紅色定位圖示 */
const redIcon=L.icon({
  iconUrl:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41"><path fill="%23ef4444" stroke="%23b91c1c" d="M12.5 0C5.6 0 0 5.7 0 12.7c0 8.5 10.2 18.9 11.3 20 .6.6 1.7.6 2.3 0C14.9 31.6 25 21.2 25 12.7 25 5.7 19.4 0 12.5 0z"/><circle cx="12.5" cy="12.5" r="5.5" fill="%23ffffff"/></svg>',
  iconSize:[25,41],
  iconAnchor:[12,41],
  popupAnchor:[1,-34]
});

/* ===== 工具 ===== */
const toRad=d=>d*Math.PI/180;
const haversineKm=(a,b)=>{const R=6371,dLat=toRad(b[0]-a[0]),dLon=toRad(b[1]-a[1]);const s=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLon/2)**2;return 2*R*Math.asin(Math.sqrt(s));};
const fmtKm=k=>k==null?'—':(k<1?`${(k*1000|0)} m`:`${k.toFixed(1)} km`);
const pad=n=>String(n).padStart(2,'0');
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const parseNum=v=>{const n=parseFloat(v);return Number.isFinite(n)?n:null;};

/* 日期與票價 */
function fmtDateTime(iso){
  if(!iso) return '時間未定';
  const d=new Date(iso);
  if(Number.isNaN(+d)) return '時間未定';
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function extractPrices(rawMin, rawMax, rawStr){
  const nums=[]; const push=v=>{const n=parseNum(v); if(n!=null) nums.push(n);};
  push(rawMin); push(rawMax);
  if(typeof rawStr==='string'){ (rawStr.match(/\d+(\.\d+)?/g)||[]).forEach(s=>nums.push(parseFloat(s))); }
  if(nums.length===0) return {min:null,max:null,label:'票價未提供'};
  const mn=Math.min(...nums), mx=Math.max(...nums);
  if(mn===0 && mx===0) return {min:0,max:0,label:'免費'};
  if(mn===0 && mx>0) return {min:0,max:mx,label:`免費～${mx} 元`};
  if(mn===mx) return {min:mn,max:mn,label:`${mn} 元`};
  return {min:mn,max:mx,label:`${mn}～${mx} 元`};
}

/* 封面：無 image 則用 SVG 佔位 */
function coverFor(ev){
  const T={展覽:'#8b5cf6', 表演:'#f97316', 講座:'#22c55e', 電影:'#0ea5e9', 市集:'#eab308', 其他:'#94a3b8'};
  const c=T[ev.type]||T['其他']; const txt=(ev.type||'活').slice(0,1);
  const t=encodeURIComponent; const svg=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 675'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='${c}'/><stop offset='100%' stop-color='#111827'/></linearGradient></defs><rect fill='url(#g)' width='1200' height='675'/><circle cx='980' cy='-40' r='260' fill='#ffffff22'/><text x='60' y='520' font-family='Inter, Noto Sans TC' font-weight='900' font-size='520' fill='#ffffffdd'>${txt}</text></svg>`;
  return `data:image/svg+xml;charset=UTF-8,${t(svg)}`;
}

/* ===== 載入與清洗（擴充版） ===== */
function normalizeRow(row){
  const typeMap=new Map([['演出','表演'],['音樂會','表演'],['音樂','表演'],['talk','講座']]);
  const t=(row.type||'').trim(); const type=typeMap.get(t)||t||'其他';
  const venue=row.venue||{};
  const addressParts=[venue.address,venue.street,venue.road,venue.city,venue.town,venue.district,venue.zip].filter(Boolean).join('');
  const images=[]
    .concat(row.images||row.photos||row.gallery||[])
    .concat(row.image||row.cover?[row.image||row.cover]:[])
    .filter(Boolean);
  const image=images[0]||null;

  const priceStr=row.price||row.fee||row.ticket_info||null;
  const prices=extractPrices(row.price_min,row.price_max,priceStr);

  const organizers=[].concat(row.organizers||row.organizer||row.host||[]).flat().filter(Boolean).map(x=>typeof x==='string'?x:(x.name||''));
  const performers=[].concat(row.performers||row.speakers||row.artists||[]).flat().filter(Boolean).map(x=>typeof x==='string'?x:(x.name||''));
  const tags=[].concat(row.tags||row.keywords||row.categories||[]).flat().filter(Boolean).map(String);

  const lat=parseNum(venue.lat), lng=parseNum(venue.lng);

  const n={
    id: row.id || `evt_${crypto.randomUUID?.()||Math.random().toString(36).slice(2)}`,
    title: (row.title||row.name||'').trim(),
    type,
    desc: (row.desc||row.description||'').trim(),
    start_at: row.start_at||row.start||row.date||null,
    end_at: row.end_at||row.end||null,
    url: row.url||row.link||'',
    ticket_url: row.ticket_url||row.tickets||'',
    reg_url: row.registration_url||row.reg_url||'',
    price_min: prices.min, price_max: prices.max, price_label: prices.label,
    venue:{name:venue.name||row.venue_name||'', address:addressParts||'', district:(venue.district||venue.area||row.district||'').trim()},
    lat, lng,
    organizers, performers, tags, images, image,
    age_limit: row.age_limit||row.age||'',
    accessibility: row.accessibility||row.facilities||[],
    opening_hours: row.opening_hours||row.hours||'',
    source: row.source||row.provider||'',
    updated_at: row.updated_at||row.modified||'',
    series: row.series||row.program||''
  };

  n._hay=[n.title,n.type,n.desc,n.venue.name,n.venue.address,n.venue.district,
          ...organizers,...performers,...tags,n.series,n.ticket_url,n.reg_url]
          .filter(Boolean).join(' ').toLowerCase();
  return n;
}
function dedupeTaipei(rows){
  const seen=new Set(), out=[];
  for(const r of rows){
    if(!TAIPEI_DISTRICTS.has(r.venue.district)) continue;
    const key=(r.title||'')+'|'+(r.start_at||'')+'|'+(r.venue.name||'');
    if(seen.has(key)) continue; seen.add(key); out.push(r);
  }
  return out;
}
async function loadFromEventsJson(){
  try{
    const res=await fetch('events.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const raw=await res.json();
    const arr=(raw.results||raw||[]).map(normalizeRow);
    return dedupeTaipei(arr);
  }catch(e){
    const seed=JSON.parse(document.getElementById('seed').textContent).results||[];
    return dedupeTaipei(seed.map(normalizeRow));
  }
}

/* ===== 日期多選狀態與工具 ===== */
let selectedDates = new Set(); // 'YYYY-MM-DD'
const dateOnly = (iso)=>{
  const d = new Date(iso);
  return Number.isNaN(+d)? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
};
function renderDateChips(){
  const box=document.getElementById('dateChips');
  box.innerHTML='';
  [...selectedDates].sort().forEach(ds=>{
    const chip=document.createElement('button');
    chip.className='chip';
    chip.type='button';
    chip.textContent=ds+' ×';
    chip.setAttribute('data-date', ds);
    chip.style.cursor='pointer';
    chip.onclick=()=>{ selectedDates.delete(ds); renderDateChips(); applyFilters(); };
    box.appendChild(chip);
  });
}
function occursOnAnySelectedDate(ev,set){
  if(!set || set.size===0) return true;
  const s = ev.start_at? dateOnly(ev.start_at): null;
  if(!s) return false;
  const e = ev.end_at? dateOnly(ev.end_at): s;
  for(const ds of set){
    const [Y,M,D]=ds.split('-').map(n=>parseInt(n,10));
    const q = new Date(Y, M-1, D);
    if(q>=s && q<=e) return true;
  }
  return false;
}

/* ===== 對應呈現 ===== */
function render(list){
  markers.clearLayers();
  const wrap=document.getElementById('list'); wrap.innerHTML='';
  list.forEach(ev=>{
    const distKm=(myPos && ev.lat!=null && ev.lng!=null)?haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]):null;
    ev._distance_km=distKm;

    if(ev.lat!=null && ev.lng!=null){
      L.marker([ev.lat,ev.lng]).addTo(markers)
        .bindPopup(`<strong>${ev.title}</strong><br/>${ev.venue.name}<br/>${fmtKm(distKm)}`)
        .on('click',()=>openDetail(ev));
    }

    const chips = [];
    if (ev.tags?.length) chips.push(...ev.tags.slice(0,2));
    if (ev.series) chips.push(`系列:${ev.series}`);

    const card=document.createElement('article'); card.className='card'; card.tabIndex=0;
    card.innerHTML=`
      <img class="cover" alt="" src="${ev.image||coverFor(ev)}">
      <div class="card-body">
        <div class="badges">
          <span class="badge">${ev.type||'其他'}</span>
          <span class="chip">${ev.venue.district||'行政區未知'}</span>
          ${chips.map(c=>`<span class="chip">${c}</span>`).join('')}
        </div>
        <h3 class="title">${ev.title}</h3>
        <p class="meta"><span>${fmtDateTime(ev.start_at)}</span><span>· 距離 ${fmtKm(distKm)}</span></p>
        <p class="sub">${ev.venue.name||''}</p>
        <div class="actions-row">
          ${ev.url?`<a class="btn link" href="${ev.url}" target="_blank" rel="noopener">活動頁</a>`:''}
          <button class="btn" data-act="more">詳細</button>
        </div>
      </div>`;
    card.querySelector('[data-act="more"]').addEventListener('click',e=>{ e.stopPropagation(); openDetail(ev); });
    card.addEventListener('click',()=>openDetail(ev));
    card.addEventListener('keydown',e=>{ if(e.key==='Enter') openDetail(ev); });
    wrap.appendChild(card);
  });
}

/* ===== 篩選 ===== */
function applyFilters(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const type=document.getElementById('type').value;
  const dist=document.getElementById('district').value;
  const maxKm=parseFloat(document.getElementById('maxKm').value);

  const filtered=allEvents.filter(ev=>{
    if(q && !(`${ev._hay}`.includes(q))) return false;
    if(type && ev.type!==type) return false;
    if(dist && ev.venue.district!==dist) return false;
    if(!occursOnAnySelectedDate(ev, selectedDates)) return false;
    if(!isNaN(maxKm)){
      if(ev._distance_km==null) return false;
      if(ev._distance_km>maxKm) return false;
    }
    return true;
  }).sort((a,b)=>{
    const da=a._distance_km??Infinity, db=b._distance_km??Infinity;
    if(da!==db) return da-db;
    const ta=a.start_at?+new Date(a.start_at):Infinity, tb=b.start_at?+new Date(b.start_at):Infinity;
    return ta-tb;
  });

  render(filtered);
}

/* ===== 詳細視窗（擴充顯示） ===== */
function openDetail(ev){
  const dlg=document.getElementById('detail');
  const img=document.getElementById('d-img');
  img.src = ev.image || coverFor(ev);
  img.alt = ev.title;

  document.getElementById('d-title').textContent=ev.title||'活動';
  document.getElementById('d-type').textContent=ev.type||'類型未知';
  document.getElementById('d-district').textContent=ev.venue?.district||'行政區未知';

  const s=ev.start_at?new Date(ev.start_at):null;
  const e=ev.end_at?new Date(ev.end_at):null;
  const timeLine = s? (e && +e>+s ? `${s.toLocaleString()} ～ ${e.toLocaleString()}` : s.toLocaleString()) : '時間未定';
  document.getElementById('d-time').textContent = timeLine;

  const chips=[];
  if(ev.tags?.length) chips.push(...ev.tags.slice(0,6));
  if(ev.series) chips.push(`系列：${ev.series}`);
  document.getElementById('d-venue').textContent = [ev.venue?.name||'', chips.length?`｜ ${chips.join(' · ')}`:''].join('');

  const extra=[];
  if (ev.organizers?.length) extra.push(`主辦：${ev.organizers.join('、')}`);
  if (ev.performers?.length) extra.push(`講者/演出：${ev.performers.join('、')}`);
  if (ev.age_limit) extra.push(`年齡：${ev.age_limit}`);
  if (ev.accessibility?.length) extra.push(`無障礙：${(Array.isArray(ev.accessibility)?ev.accessibility:[ev.accessibility]).join('、')}`);
  if (ev.opening_hours) extra.push(`開放：${ev.opening_hours}`);
  if (ev.source) extra.push(`來源：${ev.source}`);
  if (ev.updated_at) extra.push(`更新：${ev.updated_at}`);

  document.getElementById('d-addr').textContent=[ev.venue?.address||'', ...extra].filter(Boolean).join(' ｜ ');
  document.getElementById('d-desc').textContent=ev.desc||'';
  document.getElementById('d-price').textContent=ev.price_label||'票價未提供';

  const bar=document.querySelector('.toolbar'); bar.querySelectorAll('a[data-extra]').forEach(x=>x.remove());
  const link=document.getElementById('d-url');
  if(ev.url){ link.href=ev.url; link.style.display='inline-flex'; } else { link.style.display='none'; }
  if (ev.ticket_url){
    const a=document.createElement('a'); a.className='btn link'; a.textContent='購票'; a.target='_blank'; a.rel='noopener'; a.href=ev.ticket_url; a.setAttribute('data-extra',''); bar.appendChild(a);
  }
  if (ev.reg_url){
    const a=document.createElement('a'); a.className='btn link'; a.textContent='報名'; a.target='_blank'; a.rel='noopener'; a.href=ev.reg_url; a.setAttribute('data-extra',''); bar.appendChild(a);
  }

  dlg.showModal();
  dlg.addEventListener('keydown',e=>{ if(e.key==='Escape') dlg.close(); }, {once:true});
}
document.getElementById('d-close').addEventListener('click',()=>document.getElementById('detail').close());
document.getElementById('detail').addEventListener('click',e=>{
  const dlg=e.currentTarget, rect=dlg.getBoundingClientRect();
  if(e.clientX<rect.left||e.clientX>rect.right||e.clientY<rect.top||e.clientY>rect.bottom) dlg.close();
});

/* 分享與複製 */
document.getElementById('btnShare').addEventListener('click',async()=>{
  const a=document.getElementById('d-url'); const url=a?.href||location.href;
  const title=document.getElementById('d-title').textContent;
  try{ if(navigator.share){ await navigator.share({title,text:title,url}); return; } }catch(e){}
  try{ await navigator.clipboard.writeText(url); alert('已複製連結'); }catch(e){ alert(url); }
});
document.getElementById('btnCopy').addEventListener('click',async()=>{
  const a=document.getElementById('d-url'); const url=a?.href||location.href;
  try{ await navigator.clipboard.writeText(url); alert('已複製連結'); }catch(e){ alert(url); }
});

/* 載入與綁定 */
async function boot(){
  allEvents = await loadFromEventsJson();
  if(myPos) allEvents.forEach(ev=>{
    if(ev.lat!=null && ev.lng!=null) ev._distance_km=haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]);
  });
  render(allEvents);
  renderDateChips();
}
document.getElementById('btnLoad').addEventListener('click',boot);
document.getElementById('btnFilter').addEventListener('click',applyFilters);
document.getElementById('useGeo').addEventListener('change',e=>{
  if(e.target.checked){
    if(!navigator.geolocation){ alert('此瀏覽器不支援定位'); e.target.checked=false; return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      myPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
      if(meMarker) map.removeLayer(meMarker);
      /* 修改：我的位置使用紅色標記 */
      meMarker=L.marker([myPos.lat,myPos.lng],{title:'我的位置',icon:redIcon}).addTo(map).bindPopup('我的位置');
      map.setView([myPos.lat,myPos.lng],13);
      allEvents.forEach(ev=>{
        if(ev.lat!=null && ev.lng!=null) ev._distance_km=haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]);
      });
      applyFilters();
    },err=>{ alert('定位失敗：'+err.message); e.target.checked=false; },{enableHighAccuracy:true,timeout:10000});
  }else{
    myPos=null; if(meMarker){ map.removeLayer(meMarker); meMarker=null; }
    allEvents.forEach(ev=>ev._distance_km=null); applyFilters();
  }
});

/* 日期多選綁定 */
document.getElementById('addDate').addEventListener('click', ()=>{
  const input=document.getElementById('pickDate');
  if(input.value){
    selectedDates.add(input.value);
    renderDateChips();
    applyFilters();
  }
});
document.getElementById('clearDates').addEventListener('click', ()=>{
  selectedDates.clear();
  renderDateChips();
  applyFilters();
});

/* 開頁即嘗試讀取 events.json */
boot();
</script>
</body>
</html>
