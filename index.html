<!doctype html>
<meta charset="utf-8">
<title>藝文活動搜尋</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,sans-serif;max-width:900px;margin:24px auto;padding:0 12px}
  header{display:grid;grid-template-columns:1fr 160px 160px 120px 90px;gap:8px}
  .cards{margin-top:12px}
  .card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0}
  .title{font-weight:700}
  .meta{font-size:14px;opacity:.8}
</style>

<header>
  <input id="q" placeholder="關鍵字"/>
  <select id="type"><option value="">所有類型</option></select>
  <select id="district"><option value="">所有行政區</option></select>
  <select id="weekday">
    <option value="">所有星期</option>
    <option value="一">星期一</option><option value="二">星期二</option>
    <option value="三">星期三</option><option value="四">星期四</option>
    <option value="五">星期五</option><option value="六">星期六</option>
    <option value="日">星期日</option>
  </select>
  <label><input type="checkbox" id="freeOnly"> 免費</label>
</header>

<div style="margin:10px 0">
  <input type="date" id="from"> 至 <input type="date" id="to">
  <button id="search">搜尋</button>
  <span id="stats"></span>
</div>

<section class="cards" id="cards"></section>

<script>
const API = '';
init();

async function init(){
  const meta = await fetch(API + '/meta').then(r=>r.json());
  fillSelect('type', meta.types);
  fillSelect('district', meta.districts);
  document.getElementById('search').onclick = run;
  run();
}

function fillSelect(id, arr){
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">全部</option>' + arr.map(v=>`<option>${esc(v)}</option>`).join('');
}

async function run(){
  const p = new URLSearchParams();
  v('q') && p.set('q', v('q'));
  v('type') && p.set('type', v('type'));
  v('district') && p.set('district', v('district'));
  v('weekday') && p.set('weekday', v('weekday'));
  if (document.getElementById('freeOnly').checked) p.set('freeOnly','true');
  v('from') && p.set('dateFrom', v('from'));
  v('to') && p.set('dateTo', v('to'));

  const url = API + '/events?' + p.toString();
  const data = await fetch(url).then(r=>r.json());
  document.getElementById('stats').textContent = `共 ${data.total} 筆`;
  render(data.results);
}

function v(id){ return document.getElementById(id).value.trim(); }
function esc(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

function render(list){
  const el = document.getElementById('cards');
  el.innerHTML = list.map(d=>card(d)).join('') || '無結果';
}

function card(d){
  const v = d.venue || {};
  const title = d.title || d.name || '(無標題)';
  const type = d.type || d.category || '未分類';
  const venue = v.name || d.venue_name || '未知場地';
  const district = v.district || v.area || d.district || '';
  const start = d.start_at || d.start || d.date || '';
  const end = d.end_at || d.end || '';
  const url = d.url || d.link || '';
  return `
    <article class="card">
      <div class="title">${esc(title)}</div>
      <div class="meta">${esc(type)} ｜ ${esc(venue)}${district?'（'+esc(district)+'）':''} ｜ ${esc([start,end].filter(Boolean).join(' ~ '))}</div>
      ${url ? `<a href="${esc(url)}" target="_blank" rel="noopener">官方連結</a>` : ''}
      ${d.desc ? `<div>${esc(d.desc)}</div>` : ''}
    </article>
  `;
}
</script>
