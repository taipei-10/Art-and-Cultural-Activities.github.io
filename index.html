<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>臺北藝文活動搜尋</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* ===== Design tokens ===== */
    :root{
      --brand:#3a86ff; --brand-ink:#0b57d0; --bg:#fafafa; --panel:#ffffff; --ink:#101114; --ink-2:#4b5563;
      --muted:#e5e7eb; --border:#e6e6e6; --accent:#eef4ff; --shadow:0 1px 2px rgba(16,18,27,.06),0 8px 24px rgba(16,18,27,.08);
      --radius:14px; --radius-sm:10px;
      --s1:6px; --s2:10px; --s3:14px; --s4:18px; --s5:24px; --s6:32px;
      --fz-12:clamp(11px,.8vw,12px); --fz-14:clamp(13px,.9vw,14px); --fz-16:clamp(14px,1vw,16px);
      --fz-18:clamp(16px,1.1vw,18px); --fz-22:clamp(18px,1.6vw,22px); --fz-28:clamp(22px,2.2vw,28px); --fz-40:clamp(28px,4vw,40px);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1216; --panel:#151a21; --ink:#eef2f7; --ink-2:#a3adc2; --muted:#222a35; --border:#1f2630; --accent:#14223a;
        --shadow:0 1px 2px rgba(0,0,0,.3),0 12px 30px rgba(0,0,0,.35); }
    }
    /* ===== Base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#fff0);color:var(--ink);
      font-family:Inter,"Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",Arial,sans-serif;
      font-size:var(--fz-16);line-height:1.6}
    a{color:inherit}
    /* ===== Layout ===== */
    .sidebar{position:fixed;inset:0 auto 0 0;width:min(360px,90vw);background:var(--panel);border-right:1px solid var(--border);
      display:grid;grid-template-rows:auto 1fr auto;padding:var(--s5);gap:var(--s5)}
    .content{margin-left:min(360px,90vw);min-height:100dvh;display:grid;grid-template-rows:auto auto 1fr}
    .hero{padding:var(--s6) var(--s6) var(--s4)}
    .hero h1{font-size:var(--fz-40);margin:0 0 var(--s2);letter-spacing:.5px;font-weight:800}
    .hero p{margin:0;color:var(--ink-2);font-size:var(--fz-18)}
    .map-wrap{padding:0 var(--s6) var(--s5)}
    .map{width:100%;height:360px;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .grid{padding:0 var(--s6) var(--s6);display:grid;grid-template-columns:repeat(12,1fr);gap:var(--s5)}
    .card{grid-column:span 4}
    @media (max-width:1200px){.card{grid-column:span 6}}
    @media (max-width:720px){
      .sidebar{position:static;width:100%;border-right:0;border-bottom:1px solid var(--border)}
      .content{margin-left:0}.map{height:300px}.card{grid-column:span 12}
    }
    /* ===== Sidebar ===== */
    .brand{display:flex;align-items:center;gap:var(--s3)}
    .logo{inline-size:44px;block-size:44px;border-radius:12px;display:grid;place-items:center;font-weight:900;letter-spacing:1px;
      background:linear-gradient(135deg,var(--brand),var(--brand-ink));color:#fff;box-shadow:var(--shadow)}
    .brand-txt{font-weight:800;font-size:var(--fz-22);letter-spacing:.6px}
    .panel{background:linear-gradient(180deg,var(--panel),color-mix(in oklab,var(--panel),var(--accent) 8%));
      border:1px solid var(--border);border-radius:var(--radius);padding:var(--s5);box-shadow:var(--shadow)}
    .panel-title{font-size:var(--fz-18);margin:0 0 var(--s3);font-weight:700}
    .field{display:grid;gap:6px;margin-bottom:var(--s4)}
    .field>span{font-size:var(--fz-12);color:var(--ink-2);letter-spacing:.4px;text-transform:uppercase}
    input,select{width:100%;padding:10px 12px;font-size:var(--fz-14);border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--ink)}
    input::placeholder{color:#9aa3af}
    .switch{display:flex;align-items:center;gap:10px;margin:var(--s2) 0 var(--s4);font-size:var(--fz-14);color:var(--ink-2)}
    .actions{display:flex;gap:10px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;font-weight:600;font-size:var(--fz-14)}
    .btn:hover{filter:brightness(.98)}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.link{display:inline-block;margin-top:var(--s3);border-color:transparent;background:var(--accent);color:var(--brand-ink)}
    .help{margin:var(--s3) 0 0;color:var(--ink-2);font-size:var(--fz-12)}
    .foot{color:var(--ink-2);font-size:var(--fz-12)}
    /* ===== Cards ===== */
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius-sm);padding:var(--s5);
      box-shadow:var(--shadow);transition:transform .12s ease,box-shadow .12s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 2px 6px rgba(0,0,0,.06),0 12px 28px rgba(0,0,0,.12)}
    .card-head{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .badge{background:color-mix(in oklab,var(--brand),#fff 80%);color:var(--brand-ink);
      border:1px solid color-mix(in oklab,var(--brand),#000 12%);padding:4px 10px;border-radius:999px;font-size:var(--fz-12);font-weight:700;letter-spacing:.3px}
    .chip{background:var(--muted);color:color-mix(in oklab,var(--ink),#000 15%);padding:4px 10px;border-radius:999px;font-size:var(--fz-12)}
    .card-title{margin:6px 0 4px;font-size:var(--fz-22);font-weight:800;letter-spacing:.2px;line-height:1.35}
    .card-meta{margin:0 0 6px;color:var(--ink-2);font-size:var(--fz-14);display:flex;gap:10px;flex-wrap:wrap}
    .card-sub{margin:0;color:color-mix(in oklab,var(--ink),#000 10%)}
    /* ===== Detail dialog ===== */
    dialog#detail{border:0;padding:0;max-width:720px;width:min(92vw,720px);border-radius:16px;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .detail{background:var(--panel);color:var(--ink);border:1px solid var(--border);border-radius:16px;padding:var(--s5)}
    .detail header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .detail h3{margin:0;font-size:var(--fz-28);font-weight:800}
    #d-close{border:0;background:transparent;font-size:20px;cursor:pointer;color:var(--ink-2)}
    .d-meta{margin:0 0 8px;color:var(--ink-2)}
    .d-venue,.d-addr,.d-desc,.d-price{margin:6px 0}
    .d-price{font-weight:700}
    .d-link a{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:10px;background:var(--brand);color:#fff;text-decoration:none}
    /* ===== Leaflet tune ===== */
    .leaflet-control-container .leaflet-control{border-radius:8px;overflow:hidden}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">TAIPEI</div>
      <div class="brand-txt">藝文活動搜尋</div>
    </div>

    <div class="panel">
      <h2 class="panel-title">搜尋與篩選</h2>
      <label class="field">
        <span>關鍵字</span>
        <input id="q" type="search" placeholder="輸入活動或場館關鍵字"/>
      </label>

      <label class="field">
        <span>類型</span>
        <select id="type">
          <option value="">全部</option>
          <option>展覽</option><option>表演</option><option>講座</option>
          <option>電影</option><option>市集</option><option>其他</option>
        </select>
      </label>

      <label class="field">
        <span>行政區</span>
        <select id="district">
          <option value="">全部</option>
          <option>中正區</option><option>大同區</option><option>中山區</option><option>松山區</option>
          <option>大安區</option><option>萬華區</option><option>信義區</option><option>士林區</option>
          <option>北投區</option><option>內湖區</option><option>南港區</option><option>文山區</option>
        </select>
      </label>

      <label class="field">
        <span>星期</span>
        <select id="weekday">
          <option value="">全部</option>
          <option value="0">日</option><option value="1">一</option><option value="2">二</option>
          <option value="3">三</option><option value="4">四</option><option value="5">五</option><option value="6">六</option>
        </select>
      </label>

      <label class="field">
        <span>最大距離（公里）</span>
        <input id="maxKm" type="number" min="0" step="0.5" placeholder="不限制"/>
      </label>

      <label class="switch">
        <input type="checkbox" id="useGeo" />
        <span>顯示與我距離</span>
      </label>

      <div class="actions">
        <button id="btnLoad" class="btn primary">載入資料</button>
        <button id="btnFilter" class="btn">套用篩選</button>
      </div>

      <p class="help">啟用定位後，依距離排序。</p>
    </div>

    <footer class="foot">
      <small>© Taipei Open Culture • Leaflet + OSM</small>
    </footer>
  </aside>

  <main class="content">
    <header class="hero">
      <h1>發現本週的藝文靈感</h1>
      <p>依類型、行政區與星期快速篩選。查看地圖與距離。</p>
    </header>

    <section class="map-wrap">
      <div id="map" class="map"></div>
    </section>

    <section class="grid" id="list" aria-live="polite"></section>
  </main>

  <!-- 詳細資料視窗 -->
  <dialog id="detail">
    <article class="detail">
      <header>
        <h3 id="d-title"></h3>
        <button id="d-close" aria-label="關閉">✕</button>
      </header>
      <p class="d-meta"><span id="d-type"></span> · <span id="d-district"></span> · <span id="d-time"></span></p>
      <p class="d-venue" id="d-venue"></p>
      <p class="d-addr" id="d-addr"></p>
      <p class="d-desc" id="d-desc"></p>
      <p class="d-price" id="d-price"></p>
      <p class="d-link"><a id="d-url" target="_blank" rel="noopener">前往活動頁</a></p>
    </article>
  </dialog>

  <!-- 內嵌你的 JSON 資料 -->
  <script type="application/json" id="seed">
  {
    "results": [
      {
        "title": "城市光影—短片巡演",
        "desc": "精選本地創作者短片放映暨映後談。",
        "type": "電影",
        "start_at": "2025-10-18T19:00:00",
        "end_at": "2025-10-18T21:00:00",
        "url": "https://example.com/event/film",
        "price_min": 0,
        "price_max": 200,
        "venue": { "name": "台北市中山堂 光點廳", "district": "中正區", "lat": 25.0435, "lng": 121.5167 }
      },
      {
        "title": "王大閎建築劇場「登月：氣味與聲音劇場」",
        "desc": "跨感官的建築與聲音裝置展演。",
        "type": "展覽",
        "start_at": "2025-10-21T00:00:00",
        "end_at": "2025-12-21T23:59:59",
        "url": "https://www.tfam.museum/",
        "price_min": null,
        "price_max": null,
        "venue": { "name": "臺北市立美術館", "district": "中山區", "lat": 25.0723, "lng": 121.5249 }
      },
      {
        "title": "2025自綠生活節",
        "desc": "戶外主題市集與永續生活展。",
        "type": "市集",
        "start_at": "2025-10-18T00:00:00",
        "end_at": "2025-10-19T23:59:59",
        "url": "https://www.huashan1914.com/",
        "price_min": null,
        "price_max": null,
        "venue": { "name": "華山1914文化創意產業園區", "district": "中正區", "lat": 25.0447, "lng": 121.5299 }
      }
    ]
  }
  </script>

  <script>
    /* ===== 地圖與狀態 ===== */
    const TAIPEI_CENTER=[25.0419,121.5654];
    const map=L.map('map',{scrollWheelZoom:false}).setView(TAIPEI_CENTER,12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    let meMarker=null,myPos=null,markers=L.layerGroup().addTo(map);
    let allEvents=[];

    /* ===== 工具 ===== */
    const toRad=d=>d*Math.PI/180;
    const haversineKm=(a,b)=>{const R=6371,dLat=toRad(b[0]-a[0]),dLon=toRad(b[1]-a[1]);
      const s=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));};
    const fmtKm=k=>k==null?'—':(k<1?`${(k*1000|0)} m`:`${k.toFixed(1)} km`);
    const weekdayOf=iso=>new Date(iso).getDay();
    const fmtPrice=(min,max)=>{
      if(min==null && max==null) return '票價未提供';
      if(min==null) return `最高 ${max} 元`;
      if(max==null) return `最低 ${min} 元`;
      if(min===0 && max===0) return '免費';
      if(min===0 && max>0) return `免費～${max} 元`;
      return `${min}～${max} 元`;
    };

    /* ===== 載入內嵌 JSON ===== */
    function loadSeed(){
      try{
        const seed = JSON.parse(document.getElementById('seed').textContent);
        const rows = seed.results || [];
        return rows.map(row=>({
          id:`local_${crypto.randomUUID?.()||Math.random()}`,
          title:row.title, type:row.type||'其他', desc:row.desc||'',
          start_at:row.start_at||null, end_at:row.end_at||null,
          url:row.url||'', price_min:row.price_min??null, price_max:row.price_max??null,
          venue:{ name:row.venue?.name||'', address:row.venue?.address||'', district:row.venue?.district||'' },
          lat:row.venue?.lat??null, lng:row.venue?.lng??null
        }));
      }catch(e){ console.warn('JSON 解析失敗',e); return []; }
    }

    /* ===== 呈現 ===== */
    function render(list){
      markers.clearLayers();
      const wrap=document.getElementById('list'); wrap.innerHTML='';
      list.forEach(ev=>{
        const distKm=(myPos && ev.lat!=null && ev.lng!=null)?haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]):null;
        ev._distance_km=distKm;

        if(ev.lat!=null && ev.lng!=null){
          L.marker([ev.lat,ev.lng]).addTo(markers)
            .bindPopup(`<strong>${ev.title}</strong><br/>${ev.venue.name}<br/>${fmtKm(distKm)}`)
            .on('click',()=>openDetail(ev));
        }

        const dstr=ev.start_at?new Date(ev.start_at).toLocaleString():'時間未定';
        const card=document.createElement('article'); card.className='card';
        card.innerHTML=`
          <div class="card-head">
            <span class="badge">${ev.type}</span>
            <span class="chip">${ev.venue.district||'行政區未知'}</span>
          </div>
          <h3 class="card-title">${ev.title}</h3>
          <p class="card-meta"><span>${dstr}</span><span>· 距離 ${fmtKm(distKm)}</span></p>
          <p class="card-sub">${ev.venue.name}｜${ev.venue.address||'地址未知'}</p>
          ${ev.url?`<a class="btn link" href="${ev.url}" target="_blank" rel="noopener">活動連結</a>`:''}
        `;
        card.addEventListener('click',()=>openDetail(ev));
        wrap.appendChild(card);
      });
    }

    /* ===== 篩選 ===== */
    function applyFilters(){
      const q=document.getElementById('q').value.trim();
      const type=document.getElementById('type').value;
      const dist=document.getElementById('district').value;
      const w=document.getElementById('weekday').value;
      const maxKm=parseFloat(document.getElementById('maxKm').value);

      const filtered=allEvents.filter(ev=>{
        if(q && !(`${ev.title} ${ev.venue.name} ${ev.venue.address}`.toLowerCase().includes(q.toLowerCase()))) return false;
        if(type && ev.type!==type) return false;
        if(dist && ev.venue.district!==dist) return false;
        if(w!==''){ const wd=ev.start_at?weekdayOf(ev.start_at):null; if(wd===null || String(wd)!==w) return false; }
        if(!isNaN(maxKm) && ev._distance_km!=null && ev._distance_km>maxKm) return false;
        if(!isNaN(maxKm) && ev._distance_km==null) return false;
        return true;
      }).sort((a,b)=>{
        const da=a._distance_km??Infinity, db=b._distance_km??Infinity;
        if(da!==db) return da-db;
        const ta=a.start_at?+new Date(a.start_at):Infinity, tb=b.start_at?+new Date(b.start_at):Infinity;
        return ta-tb;
      });

      render(filtered);
    }

    /* ===== 詳細視窗 ===== */
    function openDetail(ev){
      const dlg=document.getElementById('detail');
      document.getElementById('d-title').textContent=ev.title||'活動';
      document.getElementById('d-type').textContent=ev.type||'類型未知';
      document.getElementById('d-district').textContent=ev.venue?.district||'行政區未知';
      document.getElementById('d-time').textContent=ev.start_at?new Date(ev.start_at).toLocaleString():'時間未定';
      document.getElementById('d-venue').textContent=ev.venue?.name||'';
      document.getElementById('d-addr').textContent=ev.venue?.address||'';
      document.getElementById('d-desc').textContent=ev.desc||'';
      document.getElementById('d-price').textContent=fmtPrice(ev.price_min,ev.price_max);
      const link=document.getElementById('d-url');
      if(ev.url){ link.href=ev.url; link.parentElement.style.display='block'; }
      else{ link.removeAttribute('href'); link.parentElement.style.display='none'; }
      dlg.showModal();
    }
    document.getElementById('d-close').addEventListener('click',()=>document.getElementById('detail').close());
    document.getElementById('detail').addEventListener('click',e=>{
      const dlg=e.currentTarget, rect=dlg.getBoundingClientRect();
      if(e.clientX<rect.left||e.clientX>rect.right||e.clientY<rect.top||e.clientY>rect.bottom) dlg.close();
    });

    /* ===== 綁定 ===== */
    document.getElementById('btnLoad').addEventListener('click',()=>{
      allEvents = loadSeed();
      if(myPos) allEvents.forEach(ev=>{
        if(ev.lat!=null && ev.lng!=null) ev._distance_km=haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]);
      });
      render(allEvents);
    });
    document.getElementById('btnFilter').addEventListener('click',applyFilters);
    document.getElementById('useGeo').addEventListener('change',e=>{
      if(e.target.checked){
        if(!navigator.geolocation){ alert('此瀏覽器不支援定位'); e.target.checked=false; return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          myPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
          if(meMarker) map.removeLayer(meMarker);
          meMarker=L.marker([myPos.lat,myPos.lng],{title:'我的位置'}).addTo(map).bindPopup('我的位置');
          map.setView([myPos.lat,myPos.lng],13);
          allEvents.forEach(ev=>{
            if(ev.lat!=null && ev.lng!=null) ev._distance_km=haversineKm([myPos.lat,myPos.lng],[ev.lat,ev.lng]);
          });
          applyFilters();
        },err=>{ alert('定位失敗：'+err.message); e.target.checked=false; },{enableHighAccuracy:true,timeout:10000});
      }else{
        myPos=null; if(meMarker){ map.removeLayer(meMarker); meMarker=null; }
        allEvents.forEach(ev=>ev._distance_km=null); applyFilters();
      }
    });

    // 初次載入內嵌資料
    allEvents = loadSeed(); render(allEvents);
  </script>
</body>
</html>
